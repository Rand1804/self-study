![image-20240221040353712](assets/image-20240221040353712.png)

每个报文之间大概间隔3ms

![image-20240221041102669](assets/image-20240221041102669.png)

## Modbus RTU

Modbus协议诞生于1979年， 是Modicon为使用可编程逻辑控制器PLC而发表的。Modbus已经成为工业领域通讯协议的业界标准，是工业电子设备之间相当常用的连接方式

![image-20240221060510043](assets/image-20240221060510043.png)

![image-20240221060543966](assets/image-20240221060543966.png)

![image-20240221061137160](assets/image-20240221061137160.png)

## Modbus TCP

在TCP层上又封装了一层协议

![image-20240221042433650](assets/image-20240221042433650.png)

主站设备向从站设备发送请求，从站设备分析并处理主站设备的请求，然后向主站设备返回结果。在网络应用中，存在客户端和服务端，客户端发送请求到服务器，服务器向客户端返回内容。在Modbus协议中，主站发送Modbus请求，从机根据请求内容向主机返回响应，主机总是主动方，从机总是被动方

![image-20240221043448879](assets/image-20240221043448879.png)

Modbus TCP 与RTU的**主要区别**有

1. 从机地址变得不再重要。因为Modbus TCP可以通过ip地址区分从机
2. 取消了CRC校验。由于TCP IP数据包中已经存在校验，所以就不需要CRC校验
3. 多了MBAP报文头

![image-20240221043904749](assets/image-20240221043904749.png)

- **事务处理标识**可以理解为报文序列号，每次通讯之后都要加1以区别不同的通讯数据

- **协议标识**0000H表示Modbus TCP协议
- **数据长度**表示接下来的数据长度，以字节为单位
- **单元标识**可以理解为设备的从站地址

![image-20240221044438561](assets/image-20240221044438561.png)

![image-20240221044814991](assets/image-20240221044814991.png)

### 01H

![image-20240221044829828](assets/image-20240221044829828.png)

![image-20240221044931707](assets/image-20240221044931707.png)

![image-20240221045105203](assets/image-20240221045105203.png)

代表第一通道至第四通道的线圈状态为1,为触发状态，第五至第8通道的线圈状态为0,为未触发状态

![image-20240221050521724](assets/image-20240221050521724.png)

本次演示为4通道模块，返回值为1F,只需解析低四位，即F，全部为1,说明线圈为**吸合状态**

### 02H

![image-20240221051258769](assets/image-20240221051258769.png)

![image-20240221051314110](assets/image-20240221051314110.png)

>  02功能码为**按位操作寄存器**， 需要将0F转换为二进制

![image-20240221051520239](assets/image-20240221051520239.png)

0000H至0003H输入状态为1,为触发状态

![image-20240221052214024](assets/image-20240221052214024.png)

### 03H

![image-20240221052238056](assets/image-20240221052238056.png)

![image-20240221052316605](assets/image-20240221052316605.png)

> 03功能码为**按字节读取**的寄存器（读取保持寄存器）,所以一个寄存器占据两个字节，回两个字节数。第三第四字节为返回的字节数据，返回0001，说明第一通道的寄存器值为0001，第一通道的线圈为吸合状态

![image-20240221052928462](assets/image-20240221052928462.png)

### 04H

![image-20240221053028712](assets/image-20240221053028712.png)

![image-20240221053121018](assets/image-20240221053121018.png)

04功能码也是按字节操作的寄存器，所以一个寄存器返回两个字节数据

![image-20240221053644110](assets/image-20240221053644110.png)

### 05H

![image-20240221054121525](assets/image-20240221054121525.png)

该例为控制第二通道线圈吸合，第二通道的线圈地址为0001H，所以寄存器地址就写0001。控制单个线圈吸合需要向寄存器写`FF00`控制单个线圈吸合，控制断开时需要写入`0000`。05功能码发送指令与返回指令一致

![image-20240221054929895](assets/image-20240221054929895.png)

### 06H

![image-20240221055128778](assets/image-20240221055128778.png)

> 向寄存器写`0001`控制线圈吸合，向寄存器写`0000`控制线圈断开

![image-20240221055251675](assets/image-20240221055251675.png)

### 10H

![image-20240221055325981](assets/image-20240221055325981.png)

10功能码为按字节操作寄存器，一个寄存器数据占两个字节

![image-20240221055523163](assets/image-20240221055523163.png)

![image-20240221055657957](assets/image-20240221055657957.png)

### 0FH

![image-20240221055756461](assets/image-20240221055756461.png)

![image-20240221055820224](assets/image-20240221055820224.png)

![image-20240221055848284](assets/image-20240221055848284.png)